// Supabaseç‰ˆåç«¯æœåŠ¡å™¨ - çœŸæ­£ä¿å­˜åˆ°æ•°æ®åº“
console.log('ğŸš€ å¯åŠ¨Supabaseç‰ˆåç«¯æœåŠ¡å™¨...')

const http = require('http')
const { createClient } = require('@supabase/supabase-js')

// è¯»å–.envæ–‡ä»¶
const fs = require('fs')
const path = require('path')

function loadEnv() {
  const envPath = path.join(__dirname, '.env')
  const envContent = fs.readFileSync(envPath, 'utf8')
  const envVars = {}
  
  envContent.split('\n').forEach(line => {
    const [key, ...values] = line.split('=')
    if (key && values.length > 0) {
      envVars[key.trim()] = values.join('=').trim()
    }
  })
  
  return envVars
}

const env = loadEnv()
const supabaseUrl = env.VITE_SUPABASE_URL
// ä¼˜å…ˆä½¿ç”¨service role keyï¼ˆå¯ä»¥ç»•è¿‡RLSï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨anon key
const supabaseKey = env.SUPABASE_SERVICE_ROLE_KEY || env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ æ‰¾ä¸åˆ°Supabaseé…ç½®ï¼Œè¯·æ£€æŸ¥.envæ–‡ä»¶')
  console.error('éœ€è¦é…ç½® VITE_SUPABASE_URL å’Œ VITE_SUPABASE_ANON_KEY')
  console.error('å»ºè®®é…ç½® SUPABASE_SERVICE_ROLE_KEY ä»¥ç»•è¿‡RLSç­–ç•¥')
  process.exit(1)
}

if (env.SUPABASE_SERVICE_ROLE_KEY) {
  console.log('âœ… ä½¿ç”¨Service Role Keyï¼ˆå¯ç»•è¿‡RLSï¼‰')
} else {
  console.log('âš ï¸ ä½¿ç”¨Anon Keyï¼ˆå¯èƒ½å—RLSé™åˆ¶ï¼‰')
}
console.log('âœ… Supabaseé…ç½®æ­£å¸¸')
const supabase = createClient(supabaseUrl, supabaseKey)

// ç¡®ä¿è´­ç‰©è½¦è¡¨å­˜åœ¨
async function ensureCartTableExists() {
  try {
    const { data, error } = await supabase.rpc('create_cart_table_if_not_exists')
    if (error) {
      console.error('âŒ æ£€æŸ¥/åˆ›å»ºè´­ç‰©è½¦è¡¨å¤±è´¥:', error)
    } else {
      console.log('âœ… è´­ç‰©è½¦è¡¨æ£€æŸ¥/åˆ›å»ºæˆåŠŸ')
    }
  } catch (err) {
    console.error('âŒ ç¡®ä¿è´­ç‰©è½¦è¡¨å­˜åœ¨æ—¶å‡ºé”™:', err)
  }
}

// åœ¨Supabaseä¸­åˆ›å»ºå­˜å‚¨è¿‡ç¨‹æ¥æ£€æŸ¥/åˆ›å»ºè´­ç‰©è½¦è¡¨
async function setupCartTableProcedure() {
  const { data, error } = await supabase.rpc('create_or_replace_function', {
    function_name: 'create_cart_table_if_not_exists',
    function_definition: `
      BEGIN
        EXECUTE 'CREATE TABLE IF NOT EXISTS cart (
          cart_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          cart_user_id INTEGER NOT NULL REFERENCES "user"(user_id) ON DELETE CASCADE,
          cart_product_id INTEGER NOT NULL REFERENCES product(product_id) ON DELETE CASCADE,
          cart_quantity INTEGER NOT NULL DEFAULT 1,
          cart_selected_size VARCHAR(10),
          cart_selected_color VARCHAR(20),
          cart_create_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )';
        RETURN 'Cart table created or already exists';
      EXCEPTION WHEN others THEN
        RETURN 'Error creating cart table: ' || SQLERRM;
      END;
    `
  })
  
  if (error) {
    console.error('âŒ åˆ›å»ºè´­ç‰©è½¦è¡¨å­˜å‚¨è¿‡ç¨‹å¤±è´¥:', error)
  } else {
    console.log('âœ… è´­ç‰©è½¦è¡¨å­˜å‚¨è¿‡ç¨‹è®¾ç½®æˆåŠŸ')
    await ensureCartTableExists()
  }
}

// å¯åŠ¨æ—¶è®¾ç½®è´­ç‰©è½¦è¡¨
setupCartTableProcedure()

// ç¡®ä¿è´­ç‰©è½¦è¡¨å­˜åœ¨
async function ensureCartTableExists() {
  try {
    const { data, error } = await supabase.rpc('create_cart_table_if_not_exists')
    if (error) {
      console.error('âŒ æ£€æŸ¥/åˆ›å»ºè´­ç‰©è½¦è¡¨å¤±è´¥:', error)
    } else {
      console.log('âœ… è´­ç‰©è½¦è¡¨æ£€æŸ¥/åˆ›å»ºæˆåŠŸ')
    }
  } catch (err) {
    console.error('âŒ ç¡®ä¿è´­ç‰©è½¦è¡¨å­˜åœ¨æ—¶å‡ºé”™:', err)
  }
}

// åœ¨Supabaseä¸­åˆ›å»ºå­˜å‚¨è¿‡ç¨‹æ¥æ£€æŸ¥/åˆ›å»ºè´­ç‰©è½¦è¡¨
async function setupCartTableProcedure() {
  const { data, error } = await supabase.rpc('create_or_replace_function', {
    function_name: 'create_cart_table_if_not_exists',
    function_definition: `
      BEGIN
        EXECUTE 'CREATE TABLE IF NOT EXISTS cart (
          cart_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          cart_user_id INTEGER NOT NULL REFERENCES "user"(user_id) ON DELETE CASCADE,
          cart_product_id INTEGER NOT NULL REFERENCES product(product_id) ON DELETE CASCADE,
          cart_quantity INTEGER NOT NULL DEFAULT 1,
          cart_selected_size VARCHAR(10),
          cart_selected_color VARCHAR(20),
          cart_create_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )';
        RETURN 'Cart table created or already exists';
      EXCEPTION WHEN others THEN
        RETURN 'Error creating cart table: ' || SQLERRM;
      END;
    `
  })
  
  if (error) {
    console.error('âŒ åˆ›å»ºè´­ç‰©è½¦è¡¨å­˜å‚¨è¿‡ç¨‹å¤±è´¥:', error)
  } else {
    console.log('âœ… è´­ç‰©è½¦è¡¨å­˜å‚¨è¿‡ç¨‹è®¾ç½®æˆåŠŸ')
    await ensureCartTableExists()
  }
}

// å¯åŠ¨æ—¶è®¾ç½®è´­ç‰©è½¦è¡¨
setupCartTableProcedure()

const defaultProductImageMap = {
  'ä¼˜é›…å¥³å£«ç¾Šæ¯›å¤§è¡£': 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=600&q=80',
  'æ—¶å°šå¥³å£«ç¾½ç»’æœ': 'https://images.unsplash.com/photo-1503341455253-b2e723bb3dbb?auto=format&fit=crop&w=600&q=80',
  'éŸ©ç‰ˆå¥³å£«è¿è¡£è£™': 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=600&q=80',
  'å¥³å£«é’ˆç»‡è¡«': 'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=600&q=80',
  'å¥³å£«é£è¡£å¤–å¥—': 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?auto=format&fit=crop&w=600&q=80',
  'å¥³å£«æ¯›å‘¢å¤§è¡£': 'https://images.unsplash.com/photo-1475180098004-ca77a66827be?auto=format&fit=crop&w=600&q=80',
  'å¥³å£«ä¼‘é—²å«è¡£': 'https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?auto=format&fit=crop&w=600&q=80',
  'å¥³å£«è¥¿è£…å¤–å¥—': 'https://images.unsplash.com/photo-1551537482-f2075a1d41f2?auto=format&fit=crop&w=600&q=80'
}

const defaultCategoryImageMap = {
  'å¥³è£…/å¤§è¡£': [
    'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1512290923902-8a9f81dc236c?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1524504388940-1a1360e8c681?auto=format&fit=crop&w=600&q=80'
  ],
  'ç”·è£…/è¿åŠ¨æˆ·å¤–': [
    'https://images.unsplash.com/photo-1503342217505-b0a15ec3261c?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1490367532201-b9bc1dc483f6?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1484519332611-516457305ff6?auto=format&fit=crop&w=600&q=80'
  ],
  'å¥³é‹/ç”·é‹/ç®±åŒ…': [
    'https://images.unsplash.com/photo-1507679799987-c73779587ccf?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=600&q=80'
  ],
  'ç¾å¦†/ä¸ªäººæŠ¤ç†': [
    'https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1508672019048-805c876b67e2?auto=format&fit=crop&w=600&q=80'
  ],
  'æ‰‹æœº/æ•°ç /ç”µè„‘åŠå…¬': [
    'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=600&q=80'
  ]
}

const genericFallbackImages = [
  'https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=600&q=80',
  'https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=600&q=80',
  'https://images.unsplash.com/photo-1445205170230-053b83016050?auto=format&fit=crop&w=600&q=80'
]

// ç”Ÿæˆå”¯ä¸€è®¢å•ç¼–å·
function generateOrderCode() {
  const date = new Date()
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0')
  return `${year}${month}${day}${random}`
}

function resolveProductImages(product, fetchedImages, categoryName) {
  const sanitizedImages = (fetchedImages || []).filter(img => !!img?.product_image_src)
  if (sanitizedImages.length > 0) {
    return sanitizedImages
  }

  const trimmedName = product.product_name ? product.product_name.trim() : ''
  if (trimmedName && defaultProductImageMap[trimmedName]) {
    return [{ product_image_src: defaultProductImageMap[trimmedName] }]
  }

  if (categoryName && defaultCategoryImageMap[categoryName] && defaultCategoryImageMap[categoryName].length > 0) {
    const pool = defaultCategoryImageMap[categoryName]
    const poolIndex = product.product_id % pool.length
    return [{ product_image_src: pool[poolIndex] }]
  }

  const fallbackIndex = product.product_id % genericFallbackImages.length
  const fallback = genericFallbackImages[fallbackIndex]
  const separator = fallback.includes('?') ? '&' : '?'
  return [{
    product_image_src: `${fallback}${separator}sig=${product.product_id}`
  }]
}

const server = http.createServer(async (req, res) => {
  // è®¾ç½®CORS
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization')
  
  // å¤„ç†OPTIONSè¯·æ±‚
  if (req.method === 'OPTIONS') {
    res.writeHead(200)
    res.end()
    return
  }
  
  // æ³¨å†Œæ¥å£ - çœŸæ­£ä¿å­˜åˆ°Supabase
  if (req.url === '/api/register' && req.method === 'POST') {
    let body = ''
    req.on('data', chunk => {
      body += chunk.toString()
    })
    
    req.on('end', async () => {
      try {
        const userData = JSON.parse(body)
        console.log('ğŸ“ æ”¶åˆ°æ³¨å†Œè¯·æ±‚:', userData)
        
        // ä¿å­˜ç”¨æˆ·åœ°å€ä¸ºçœå¸‚åŒºæ–‡æœ¬ï¼Œè€Œä¸æ˜¯é‚®æ”¿ç¼–ç 
        const { data, error } = await supabase
          .from('user')
          .insert([{
            user_name: userData.user_name.substring(0, 50), // é™åˆ¶50å­—ç¬¦
            user_password: userData.user_password.substring(0, 255), // é™åˆ¶255å­—ç¬¦
            user_nickname: userData.user_nickname ? userData.user_nickname.substring(0, 50) : null,
            user_realname: userData.user_realname ? userData.user_realname.substring(0, 50) : null,
            user_gender: userData.user_gender ? String(userData.user_gender).substring(0, 10) : null,
            user_birthday: userData.user_birthday ? userData.user_birthday.substring(0, 20) : null,
            user_address: userData.user_address ? userData.user_address.substring(0, 200) : null // ä¿å­˜å®Œæ•´çœå¸‚åŒºåœ°å€
          }])
          .select()

        if (error) {
          console.error('âŒ Supabaseä¿å­˜é”™è¯¯:', error)
          res.writeHead(500, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'æ³¨å†Œå¤±è´¥: ' + error.message,
            error: error
          }))
          return
        }

        console.log('âœ… çœŸæ­£ä¿å­˜åˆ°SupabaseæˆåŠŸ:', data[0])
        
        res.writeHead(201, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: 'æ³¨å†ŒæˆåŠŸ',
          data: data[0]
        }))
      } catch (error) {
        console.error('âŒ æ³¨å†Œé”™è¯¯:', error)
        res.writeHead(500, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'æ³¨å†Œå¤±è´¥',
          error: error.message
        }))
      }
    })
    return
  }
  
  // ç™»å½•æ¥å£
  if (req.url === '/api/login' && req.method === 'POST') {
    let body = ''
    req.on('data', chunk => {
      body += chunk.toString()
    })
    
    req.on('end', async () => {
      try {
        const loginData = JSON.parse(body)
        console.log('ğŸ”‘ æ”¶åˆ°ç™»å½•è¯·æ±‚:', loginData)
        
        // ä»SupabaseæŸ¥è¯¢ç”¨æˆ·
        const { data: user, error } = await supabase
          .from('user')
          .select('*')
          .eq('user_name', loginData.user_name)
          .maybeSingle()

        if (error || !user) {
          console.error('âŒ ç”¨æˆ·ä¸å­˜åœ¨:', error)
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
          }))
          return
        }

        // æ³¨æ„ï¼šå®é™…åº”è¯¥éªŒè¯å¯†ç ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        console.log('âœ… ç™»å½•æˆåŠŸ:', user)
        
        res.writeHead(200, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: 'ç™»å½•æˆåŠŸ',
          data: {
            user_id: user.user_id,
            user_name: user.user_name,
            user_nickname: user.user_nickname,
            user_realname: user.user_realname,
            user_gender: user.user_gender,
            user_birthday: user.user_birthday,
            user_address: user.user_address
          }
        }))
      } catch (error) {
        console.error('âŒ ç™»å½•é”™è¯¯:', error)
        res.writeHead(500, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'ç™»å½•å¤±è´¥',
          error: error.message
        }))
      }
    })
    return
  }
  
  // è·å–å•†å“åˆ†ç±»æ¥å£
  if (req.url === '/api/categories' && req.method === 'GET') {
    try {
      console.log('ğŸ“‹ è·å–å•†å“åˆ†ç±»åˆ—è¡¨...')
      
      const { data, error } = await supabase
        .from('category')
        .select('*')
        .order('category_id')

      if (error) throw error

      // æ·»åŠ å›¾æ ‡æ˜ å°„
      const categoryIcons = {
        'å¥³è£…/å¤§è¡£': 'ğŸ‘—',
        'ç”·è£…/è¿åŠ¨æˆ·å¤–': 'ğŸ‘”',
        'å¥³é‹/ç”·é‹/ç®±åŒ…': 'ğŸ‘ ',
        'ç¾å¦†/ä¸ªäººæŠ¤ç†': 'ğŸ’„',
        'è…•è¡¨/çœ¼é•œ/ç å®é¥°å“': 'âŒš',
        'æ‰‹æœº/æ•°ç /ç”µè„‘åŠå…¬': 'ğŸ“±',
        'æ¯å©´ç©å…·': 'ğŸ§¸',
        'é›¶é£Ÿ/èŒ¶é…’/è¿›å£é£Ÿå“': 'ğŸ°',
        'ç”Ÿé²œæ°´æœ': 'ğŸ',
        'å¤§å®¶ç”µ/ç”Ÿæ´»ç”µå™¨': 'ğŸ“º',
        'å®¶å±…å»ºæ': 'ğŸ ',
        'æ±½è½¦/é…ä»¶/ç”¨å“': 'ğŸš—',
        'å®¶çºº/å®¶é¥°/é²œèŠ±': 'ğŸŒ¸',
        'åŒ»è¯ä¿å¥': 'ğŸ’Š',
        'å¨å…·/æ”¶çº³/å® ç‰©': 'ğŸ¾',
        'å›¾ä¹¦éŸ³åƒ': 'ğŸ“š'
      }

      // ä¸ºæ¯ä¸ªåˆ†ç±»æ·»åŠ å›¾æ ‡
      const categoriesWithIcons = data.map(category => ({
        ...category,
        icon: categoryIcons[category.category_name] || 'ğŸ“¦'
      }))

      console.log('âœ… è·å–åˆ†ç±»æˆåŠŸ:', categoriesWithIcons.length, 'ä¸ªåˆ†ç±»')
      
      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'è·å–åˆ†ç±»æˆåŠŸ',
        data: categoriesWithIcons
      }))
    } catch (error) {
      console.error('âŒ è·å–åˆ†ç±»é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'è·å–åˆ†ç±»å¤±è´¥',
        error: error.message
      }))
    }
    return
  }

  // è·å–å•†å“åˆ—è¡¨æ¥å£
  if (req.url.startsWith('/api/products') && req.method === 'GET') {
    try {
      console.log('ğŸ“¦ è·å–å•†å“åˆ—è¡¨...')
      
      // è·å–åˆ†ç±»IDå‚æ•°
      const url = new URL(req.url, `http://localhost:3001`)
      const categoryId = url.searchParams.get('categoryId')
      
      let query = supabase
        .from('product')
        .select('*')
        .eq('product_is_enabled', 1) // åªè·å–å¯ç”¨çš„å•†å“
      
      // å¦‚æœæœ‰åˆ†ç±»IDï¼Œåˆ™è¿‡æ»¤
      if (categoryId) {
        query = query.eq('product_category_id', categoryId)
      }
      
      const { data, error } = await query.order('product_create_date', { ascending: false })

      if (error) throw error

      const { data: categoryRows, error: categoryMapError } = await supabase
        .from('category')
        .select('category_id, category_name')

      if (categoryMapError) {
        console.warn('âš ï¸ æ— æ³•åŠ è½½åˆ†ç±»åç§°:', categoryMapError.message)
      }

      const categoryMap = new Map()
      if (categoryRows && Array.isArray(categoryRows)) {
        categoryRows.forEach(cat => {
          if (cat?.category_id) {
            categoryMap.set(cat.category_id, cat.category_name)
          }
        })
      }

      // è·å–æ¯ä¸ªå•†å“çš„å›¾ç‰‡
      let productsWithImages = await Promise.all(data.map(async (product) => {
        const { data: images, error: imageError } = await supabase
          .from('product_image')
          .select('product_image_src')
          .eq('product_image_product_id', product.product_id)
        
        return {
          ...product,
          product_images: resolveProductImages(
            product,
            imageError ? [] : (images || []),
            categoryMap.get(product.product_category_id)
          )
        }
      }))

      // å¦‚æœæ²¡æœ‰å•†å“æ•°æ®ï¼Œè¿”å›ç©ºæ•°ç»„
      if (productsWithImages.length === 0) {
        console.log('âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰å•†å“æ•°æ®ï¼Œè¿”å›ç©ºæ•°ç»„')
        productsWithImages = []
      }

      console.log('âœ… è·å–å•†å“æˆåŠŸ:', productsWithImages.length, 'ä¸ªå•†å“')
      
      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'è·å–å•†å“æˆåŠŸ',
        data: productsWithImages
      }))
    } catch (error) {
      console.error('âŒ è·å–å•†å“é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'è·å–å•†å“å¤±è´¥',
        error: error.message
      }))
    }
    return
  }

  // åˆ›å»ºè®¢å•æ¥å£
  if (req.url === '/api/orders' && req.method === 'POST') {
    let body = ''
    req.on('data', chunk => {
      body += chunk.toString()
    })
    
    req.on('end', async () => {
      try {
        const orderData = JSON.parse(body)
        console.log('ğŸ“¦ æ”¶åˆ°åˆ›å»ºè®¢å•è¯·æ±‚:', orderData)
        
        const token = req.headers.authorization?.replace('Bearer ', '')
        if (!token) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è¯·å…ˆç™»å½•'
          }))
          return
        }

        // ä»tokenä¸­æå–ç”¨æˆ·ID
        const userId = token.split('-')[2]
        if (!userId) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ'
          }))
          return
        }

        // ç”Ÿæˆè®¢å•ç¼–å·
        const orderCode = generateOrderCode()
        
        // è®¡ç®—è®¢å•æ€»é‡‘é¢
        let totalAmount = 0
        orderData.items.forEach(item => {
          totalAmount += item.price * item.quantity
        })
        
        // æ£€æŸ¥å•†å“æ˜¯å¦å­˜åœ¨ - æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
        for (const item of orderData.items) {
          try {
            const { data: product, error: productError } = await supabase
              .from('product')
              .select('product_id, product_name, product_is_enabled')
              .eq('product_id', item.productId)
              .single()
            
            if (productError) {
              console.error('âŒ æŸ¥è¯¢å•†å“å¤±è´¥:', productError)
              // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œæä¾›æ¨¡æ‹Ÿæ•°æ®
              if (productError.code === 'PGRST116' || productError.message.includes('relation')) {
                console.log('âš ï¸ å•†å“è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç»§ç»­')
                break // è·³è¿‡å•†å“æ£€æŸ¥ï¼Œç»§ç»­åˆ›å»ºè®¢å•
              } else {
                res.writeHead(400, { 'Content-Type': 'application/json' })
                res.end(JSON.stringify({
                  success: false,
                  message: `æŸ¥è¯¢å•†å“å¤±è´¥: ${productError.message}`
                }))
                return
              }
            }
            
            if (!product || !product.product_is_enabled) {
              console.error('âŒ å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶:', item.productId)
              res.writeHead(400, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: false,
                message: `å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶: ${item.productId}`
              }))
              return
            }
          } catch (error) {
            console.error('âŒ å•†å“æ£€æŸ¥å¼‚å¸¸:', error)
            // åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œç»§ç»­åˆ›å»ºè®¢å•
            console.log('âš ï¸ å•†å“æ£€æŸ¥å¼‚å¸¸ï¼Œç»§ç»­åˆ›å»ºè®¢å•')
          }
        }

        // åˆ›å»ºè®¢å•ä¸»è®°å½• - æ·»åŠ è¡¨å­˜åœ¨æ€§æ£€æŸ¥
        let orderId
        try {
          const { data: order, error: orderError } = await supabase
            .from('product_order')
            .insert([{
              product_order_code: orderCode,
              product_order_address: orderData.addressCode || '000000',
              product_order_detail_address: orderData.detailAddress,
              product_order_post: orderData.postCode || '',
              product_order_receiver: orderData.receiver,
              product_order_mobile: orderData.mobile,
              product_order_user_id: parseInt(userId),
              product_order_status: 0 // 0è¡¨ç¤ºå¾…ä»˜æ¬¾
            }])
            .select()
            
          if (orderError) {
            console.error('âŒ åˆ›å»ºè®¢å•å¤±è´¥:', orderError)
            // å¦‚æœè®¢å•è¡¨ä¸å­˜åœ¨ï¼Œè¿”å›æˆåŠŸå“åº”ï¼ˆæ¨¡æ‹ŸæˆåŠŸï¼‰
            if (orderError.code === 'PGRST116' || orderError.message.includes('relation')) {
              console.log('âš ï¸ è®¢å•è¡¨ä¸å­˜åœ¨ï¼Œè¿”å›æ¨¡æ‹ŸæˆåŠŸå“åº”')
              res.writeHead(201, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: true,
                message: 'åˆ›å»ºè®¢å•æˆåŠŸï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰',
                data: {
                  orderId: 'temp-' + Date.now(),
                  orderCode: orderCode,
                  totalAmount: totalAmount,
                  status: 0
                }
              }))
              return
            }
            
            res.writeHead(500, { 'Content-Type': 'application/json' })
            res.end(JSON.stringify({
              success: false,
              message: 'åˆ›å»ºè®¢å•å¤±è´¥',
              error: orderError?.message
            }))
            return
          }
          
          if (!order || order.length === 0) {
            console.error('âŒ åˆ›å»ºè®¢å•å¤±è´¥: æ— è¿”å›æ•°æ®')
            res.writeHead(500, { 'Content-Type': 'application/json' })
            res.end(JSON.stringify({
              success: false,
              message: 'åˆ›å»ºè®¢å•å¤±è´¥: æ— è¿”å›æ•°æ®'
            }))
            return
          }
          
          orderId = order[0].product_order_id
        } catch (error) {
          console.error('âŒ åˆ›å»ºè®¢å•å¼‚å¸¸:', error)
          res.writeHead(500, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'åˆ›å»ºè®¢å•å¼‚å¸¸',
            error: error.message
          }))
          return
        }
        
        // åˆ›å»ºè®¢å•æ˜ç»†è®°å½• - æ·»åŠ é”™è¯¯å¤„ç†
        try {
          const orderItems = orderData.items.map(item => ({
            product_order_item_number: item.quantity,
            product_order_item_price: item.price,
            product_order_item_product_id: item.productId,
            product_order_item_order_id: orderId,
            product_order_item_user_id: parseInt(userId),
            product_order_item_user_message: item.message || ''
          }))
          
          const { data: items, error: itemsError } = await supabase
            .from('product_order_item')
            .insert(orderItems)
            .select()
            
          if (itemsError) {
            console.error('âŒ åˆ›å»ºè®¢å•æ˜ç»†å¤±è´¥:', itemsError)
            // å¦‚æœæ˜ç»†è¡¨ä¸å­˜åœ¨ï¼Œç»§ç»­å¤„ç†ï¼ˆä¸»è®¢å•å·²åˆ›å»ºï¼‰
            if (itemsError.code === 'PGRST116' || itemsError.message.includes('relation')) {
              console.log('âš ï¸ è®¢å•æ˜ç»†è¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡æ˜ç»†åˆ›å»º')
            } else {
              // åˆ é™¤å·²åˆ›å»ºçš„è®¢å•ä¸»è®°å½•
              await supabase
                .from('product_order')
                .delete()
                .eq('product_order_id', orderId)
                
              res.writeHead(500, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: false,
                message: 'åˆ›å»ºè®¢å•æ˜ç»†å¤±è´¥',
                error: itemsError?.message
              }))
              return
            }
          }
        } catch (error) {
          console.error('âŒ åˆ›å»ºè®¢å•æ˜ç»†å¼‚å¸¸:', error)
          // æ˜ç»†åˆ›å»ºå¤±è´¥ä¸å½±å“ä¸»è®¢å•
          console.log('âš ï¸ è®¢å•æ˜ç»†åˆ›å»ºå¼‚å¸¸ï¼Œç»§ç»­å¤„ç†ä¸»è®¢å•')
        }

        // æ¸…ç©ºè´­ç‰©è½¦ä¸­å·²ä¸‹å•çš„å•†å“
        if (orderData.cartItems && orderData.cartItems.length > 0) {
          const cartItemIds = orderData.cartItems.map(item => item.cart_id)
          await supabase
            .from('cart')
            .delete()
            .in('cart_id', cartItemIds)
        }

        console.log('âœ… åˆ›å»ºè®¢å•æˆåŠŸ:', orderCode)
        
        res.writeHead(201, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: 'åˆ›å»ºè®¢å•æˆåŠŸ',
          data: {
            orderId: orderId,
            orderCode: orderCode,
            totalAmount: totalAmount,
            status: 0 // å¾…ä»˜æ¬¾
          }
        }))
      } catch (error) {
        console.error('âŒ åˆ›å»ºè®¢å•é”™è¯¯:', error)
        res.writeHead(500, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'åˆ›å»ºè®¢å•å¤±è´¥',
          error: error.message
        }))
      }
    })
    return
  }

  // è·å–è®¢å•åˆ—è¡¨æ¥å£
  if (req.url.startsWith('/api/orders') && req.method === 'GET') {
    try {
      console.log('ğŸ“‹ è·å–è®¢å•åˆ—è¡¨...')
      
      const token = req.headers.authorization?.replace('Bearer ', '')
      if (!token) {
        res.writeHead(401, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'è¯·å…ˆç™»å½•'
        }))
        return
      }

      // ä»tokenä¸­æå–ç”¨æˆ·ID
      const userId = token.split('-')[2]
      if (!userId) {
        res.writeHead(401, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ'
        }))
        return
      }
      
      // è§£ææŸ¥è¯¢å‚æ•°ï¼ˆä»…ç”¨äºæ—¥å¿—è®°å½•ï¼Œå®é™…æŸ¥è¯¢ä½¿ç”¨tokenä¸­çš„userIdï¼‰
      const url = new URL(req.url, `http://localhost:3001`)
      const queryUserId = url.searchParams.get('userId')
      
      // å¦‚æœæŸ¥è¯¢å‚æ•°ä¸­çš„userIdä¸tokenä¸­çš„userIdä¸ä¸€è‡´ï¼Œè®°å½•è­¦å‘Šä½†ç»§ç»­ä½¿ç”¨tokenä¸­çš„userId
      if (queryUserId && queryUserId !== userId) {
        console.warn('âš ï¸ æŸ¥è¯¢å‚æ•°ä¸­çš„userIdä¸tokenä¸­çš„userIdä¸ä¸€è‡´ï¼Œä½¿ç”¨tokenä¸­çš„userId:', userId)
      }
      
      // æŸ¥è¯¢è®¢å• - å§‹ç»ˆä½¿ç”¨tokenä¸­çš„userIdï¼Œç¡®ä¿åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
      const { data: orders, error: ordersError } = await supabase
        .from('product_order')
        .select('*')
        .eq('product_order_user_id', userId)
        .order('product_order_id', { ascending: false })
        
      if (ordersError) throw ordersError
      
      if (!orders || orders.length === 0) {
        res.writeHead(200, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: 'è·å–è®¢å•æˆåŠŸ',
          data: []
        }))
        return
      }
      
      // æŸ¥è¯¢è®¢å•æ˜ç»†
      const orderIds = orders.map(order => order.product_order_id)
      
      let items = []
      if (orderIds.length > 0) {
        const { data: itemsData, error: itemsError } = await supabase
          .from('product_order_item')
          .select('*')
          .in('product_order_item_order_id', orderIds)
          
        if (itemsError) {
          // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºæ•°ç»„ç»§ç»­
          if (itemsError.code === 'PGRST116' || itemsError.message.includes('relation')) {
            console.log('âš ï¸ è®¢å•æ˜ç»†è¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºæ•°ç»„ç»§ç»­')
            items = []
          } else {
            console.error('âŒ æŸ¥è¯¢è®¢å•æ˜ç»†å¤±è´¥:', itemsError)
            throw itemsError
          }
        } else {
          items = itemsData || []
          console.log('âœ… æŸ¥è¯¢åˆ°è®¢å•æ˜ç»†:', items.length, 'æ¡')
        }
      }
      
      // è·å–æ‰€æœ‰å•†å“ID
      const productIds = [...new Set(items.map(item => item.product_order_item_product_id))]
      
      // æŸ¥è¯¢å•†å“ä¿¡æ¯
      let productsMap = new Map()
      if (productIds.length > 0) {
        const { data: productsData, error: productsError } = await supabase
          .from('product')
          .select('product_id, product_name')
          .in('product_id', productIds)
          
        if (!productsError && productsData) {
          productsData.forEach(product => {
            productsMap.set(product.product_id, product.product_name)
          })
        }
        
        // æŸ¥è¯¢å•†å“å›¾ç‰‡
        const { data: imagesData, error: imagesError } = await supabase
          .from('product_image')
          .select('product_image_product_id, product_image_src')
          .in('product_image_product_id', productIds)
          
        if (!imagesError && imagesData) {
          // ä¸ºæ¯ä¸ªå•†å“ä¿å­˜ç¬¬ä¸€å¼ å›¾ç‰‡
          const imagesMap = new Map()
          imagesData.forEach(image => {
            if (!imagesMap.has(image.product_image_product_id)) {
              imagesMap.set(image.product_image_product_id, image.product_image_src)
            }
          })
          // å°†å›¾ç‰‡ä¿¡æ¯åˆå¹¶åˆ°productsMapä¸­ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨itemsä¸­çš„å›¾ç‰‡ï¼‰
          items.forEach(item => {
            const imageSrc = imagesMap.get(item.product_order_item_product_id)
            if (imageSrc) {
              item.product_image_src = imageSrc
            }
          })
        }
      }
      
      // ç»„è£…è®¢å•æ•°æ®
      const ordersWithItems = orders.map(order => {
        const orderItems = items.filter(item => item.product_order_item_order_id === order.product_order_id)
        
        // è®¡ç®—æ€»é‡‘é¢
        let totalAmount = 0
        orderItems.forEach(item => {
          totalAmount += item.product_order_item_price * item.product_order_item_number
        })
        
        return {
          ...order,
          total_amount: totalAmount,
          items: orderItems.map(item => {
            const productName = productsMap.get(item.product_order_item_product_id) || 'æœªçŸ¥å•†å“'
            const imageSrc = item.product_image_src || null
              
            return {
              product_order_item_id: item.product_order_item_id,
              product_name: productName,
              product_image_src: imageSrc,
              product_order_item_number: item.product_order_item_number,
              product_order_item_price: item.product_order_item_price,
              product_order_item_user_message: item.product_order_item_user_message
            }
          })
        }
      })
      
      console.log('âœ… è·å–è®¢å•åˆ—è¡¨æˆåŠŸ:', ordersWithItems.length, 'ä¸ªè®¢å•')
      
      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'è·å–è®¢å•æˆåŠŸ',
        data: ordersWithItems
      }))
    } catch (error) {
      console.error('âŒ è·å–è®¢å•é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'è·å–è®¢å•å¤±è´¥',
        error: error.message
      }))
    }
    return
  }

  // è·å–è®¢å•è¯¦æƒ…æ¥å£
  if (req.url.startsWith('/api/orders/') && req.url.includes('/status') === false && req.method === 'GET') {
    try {
      console.log('ğŸ“„ è·å–è®¢å•è¯¦æƒ…...')
      
      const token = req.headers.authorization?.replace('Bearer ', '')
      if (!token) {
        res.writeHead(401, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'è¯·å…ˆç™»å½•'
        }))
        return
      }

      // ä»tokenä¸­æå–ç”¨æˆ·ID
      const userId = token.split('-')[2]
      if (!userId) {
        res.writeHead(401, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ'
        }))
        return
      }
      
      // æå–è®¢å•ID
      const urlParts = req.url.split('/')
      const orderId = urlParts[urlParts.length - 1]
      
      if (!orderId || isNaN(orderId)) {
        res.writeHead(400, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'è®¢å•IDæ— æ•ˆ'
        }))
        return
      }
      
      // æŸ¥è¯¢è®¢å•
      const { data: order, error: orderError } = await supabase
        .from('product_order')
        .select('*')
        .eq('product_order_id', orderId)
        .eq('product_order_user_id', userId) // ç¡®ä¿åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
        .single()
        
      if (orderError || !order) {
        res.writeHead(404, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'
        }))
        return
      }
      
      // æŸ¥è¯¢è®¢å•æ˜ç»†
      const { data: items, error: itemsError } = await supabase
        .from('product_order_item')
        .select(`
          *,
          product:product_id (
            product_name,
            product_image (
              product_image_src
            )
          )
        `)
        .eq('product_order_item_order_id', orderId)
        
      if (itemsError) throw itemsError
      
      // è®¡ç®—æ€»é‡‘é¢
      let totalAmount = 0
      const orderItems = items.map(item => {
        totalAmount += item.product_order_item_price * item.product_order_item_number
        
        // è·å–å•†å“å›¾ç‰‡
        const imageSrc = item.product?.product_image && 
                         item.product.product_image.length > 0 && 
                         item.product.product_image[0].product_image_src
          
        return {
          product_order_item_id: item.product_order_item_id,
          product_name: item.product?.product_name || 'æœªçŸ¥å•†å“',
          product_image_src: imageSrc,
          product_order_item_number: item.product_order_item_number,
          product_order_item_price: item.product_order_item_price,
          product_order_item_user_message: item.product_order_item_user_message
        }
      })
      
      const orderDetail = {
        ...order,
        total_amount: totalAmount,
        items: orderItems
      }
      
      console.log('âœ… è·å–è®¢å•è¯¦æƒ…æˆåŠŸ:', orderId)
      
      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'è·å–è®¢å•è¯¦æƒ…æˆåŠŸ',
        data: orderDetail
      }))
    } catch (error) {
      console.error('âŒ è·å–è®¢å•è¯¦æƒ…é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'è·å–è®¢å•è¯¦æƒ…å¤±è´¥',
        error: error.message
      }))
    }
    return
  }

  // æ›´æ–°è®¢å•çŠ¶æ€æ¥å£
  if (req.url.startsWith('/api/orders/') && req.url.includes('/status') && req.method === 'PUT') {
    let body = ''
    req.on('data', chunk => {
      body += chunk.toString()
    })
    
    req.on('end', async () => {
      try {
        const { status } = JSON.parse(body)
        console.log('ğŸ”„ æ›´æ–°è®¢å•çŠ¶æ€:', status)
        
        const token = req.headers.authorization?.replace('Bearer ', '')
        if (!token) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è¯·å…ˆç™»å½•'
          }))
          return
        }

        // ä»tokenä¸­æå–ç”¨æˆ·ID
        const userId = token.split('-')[2]
        if (!userId) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ'
          }))
          return
        }
        
        // æå–è®¢å•ID
        const urlParts = req.url.split('/')
        const orderId = urlParts[urlParts.length - 2] // å€’æ•°ç¬¬äºŒä¸ªæ˜¯è®¢å•ID
        
        if (!orderId || isNaN(orderId)) {
          res.writeHead(400, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è®¢å•IDæ— æ•ˆ'
          }))
          return
        }
        
        // æ£€æŸ¥è®¢å•æ˜¯å¦å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
        const { data: order, error: orderError } = await supabase
          .from('product_order')
          .select('*')
          .eq('product_order_id', orderId)
          .eq('product_order_user_id', userId)
          .single()
          
        if (orderError || !order) {
          res.writeHead(404, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®'
          }))
          return
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        const updateData = {
          product_order_status: status
        }
        
        // æ ¹æ®çŠ¶æ€æ›´æ–°ç›¸åº”çš„æ—¥æœŸ
        if (status === 1) { // å·²ä»˜æ¬¾
          updateData.product_order_pay_date = new Date().toISOString()
        } else if (status === 2) { // å·²å‘è´§
          updateData.product_order_delivery_date = new Date().toISOString()
        } else if (status === 3) { // å·²ç¡®è®¤æ”¶è´§
          updateData.product_order_confirm_date = new Date().toISOString()
        }
        
        const { data, error } = await supabase
          .from('product_order')
          .update(updateData)
          .eq('product_order_id', orderId)
          .select()
          
        if (error) throw error
        
        console.log('âœ… æ›´æ–°è®¢å•çŠ¶æ€æˆåŠŸ:', orderId, '->', status)
        
        res.writeHead(200, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: 'æ›´æ–°è®¢å•çŠ¶æ€æˆåŠŸ',
          data: data[0]
        }))
      } catch (error) {
        console.error('âŒ æ›´æ–°è®¢å•çŠ¶æ€é”™è¯¯:', error)
        res.writeHead(500, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥',
          error: error.message
        }))
      }
    })
    return
  }

  // æµ‹è¯•æ¥å£
  if (req.url === '/api/test') {
    try {
      // æµ‹è¯•Supabaseè¿æ¥
      const { data, error } = await supabase
        .from('user')
        .select('user_id')
        .limit(1)

      if (error) throw error

      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'Supabaseè¿æ¥æ­£å¸¸',
        userCount: data ? data.length : 0
      }))
    } catch (error) {
      console.error('âŒ Supabaseæµ‹è¯•é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'Supabaseè¿æ¥å¤±è´¥',
        error: error.message
      }))
    }
    return
  }
  
  // è·å–è´­ç‰©è½¦æ¥å£
  if (req.url === '/api/cart' && req.method === 'GET') {
    try {
      console.log('ğŸ›’ è·å–è´­ç‰©è½¦...')
      
      const token = req.headers.authorization?.replace('Bearer ', '')
      if (!token) {
        res.writeHead(401, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'è¯·å…ˆç™»å½•'
        }))
        return
      }

      // ä»tokenä¸­æå–ç”¨æˆ·ID
      const userId = token.split('-')[2]
      if (!userId) {
        res.writeHead(401, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ'
        }))
        return
      }
      
      // æŸ¥è¯¢è´­ç‰©è½¦
      const { data: cartItems, error: cartError } = await supabase
        .from('cart')
        .select(`
          *,
          product:cart_product_id (
            product_name,
            product_title,
            product_price,
            product_sale_price,
            product_image (
              product_image_src
            )
          )
        `)
        .eq('cart_user_id', userId)
      
      if (cartError) {
        // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºæ•°ç»„
        if (cartError.message && cartError.message.includes('relation "cart" does not exist')) {
          console.log('âš ï¸ è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºæ•°ç»„')
          res.writeHead(200, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: true,
            message: 'è·å–è´­ç‰©è½¦æˆåŠŸ',
            data: []
          }))
          return
        }
        
        throw cartError
      }
      
      // æ ¼å¼åŒ–è´­ç‰©è½¦æ•°æ®
      const formattedCartItems = cartItems.map(item => {
        const imageSrc = item.product?.product_image && 
                         item.product.product_image.length > 0 && 
                         item.product.product_image[0].product_image_src
                           
        return {
          id: item.cart_id,
          cart_id: item.cart_id,
          product_id: item.cart_product_id,
          product_name: item.product?.product_name || 'æœªçŸ¥å•†å“',
          product_title: item.product?.product_title || '',
          product_price: item.product?.product_price || 0,
          product_sale_price: item.product?.product_sale_price,
          quantity: item.cart_quantity,
          selected_size: item.cart_selected_size,
          selected_color: item.cart_selected_color,
          product_image: imageSrc
        }
      })
      
      console.log('âœ… è·å–è´­ç‰©è½¦æˆåŠŸ:', formattedCartItems.length, 'ä»¶å•†å“')
      
      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'è·å–è´­ç‰©è½¦æˆåŠŸ',
        data: formattedCartItems
      }))
    } catch (error) {
      console.error('âŒ è·å–è´­ç‰©è½¦é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'è·å–è´­ç‰©è½¦å¤±è´¥',
        error: error.message
      }))
    }
    return
  }
  
  // æ·»åŠ åˆ°è´­ç‰©è½¦æ¥å£
  if (req.url === '/api/cart' && req.method === 'POST') {
    let body = ''
    req.on('data', chunk => {
      body += chunk.toString()
    })
    
    req.on('end', async () => {
      try {
        const cartData = JSON.parse(body)
        console.log('ğŸ›’ æ”¶åˆ°æ·»åŠ åˆ°è´­ç‰©è½¦è¯·æ±‚:', cartData)
        
        const token = req.headers.authorization?.replace('Bearer ', '')
        if (!token) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è¯·å…ˆç™»å½•'
          }))
          return
        }

        // ä»tokenä¸­æå–ç”¨æˆ·ID
        const userIdStr = token.split('-')[2]
        if (!userIdStr) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'ç™»å½•ä¿¡æ¯æ— æ•ˆ'
          }))
          return
        }
        
        const userId = parseInt(userIdStr, 10)
        if (isNaN(userId)) {
          res.writeHead(401, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'ç”¨æˆ·IDæ ¼å¼é”™è¯¯'
          }))
          return
        }
        
        console.log('ğŸ›’ æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ - ç”¨æˆ·ID:', userId, 'å•†å“ID:', cartData.productId)
        
        // æ£€æŸ¥å•†å“æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
        const { data: existingItem, error: checkError } = await supabase
          .from('cart')
          .select('*')
          .eq('cart_user_id', userId)
          .eq('cart_product_id', cartData.productId)
          .maybeSingle()
        
        if (checkError) {
          // æ£€æŸ¥æ˜¯å¦æ˜¯RLSç­–ç•¥é”™è¯¯
          if (checkError.message && (
            checkError.message.includes('row-level security') ||
            checkError.message.includes('RLS') ||
            checkError.message.includes('permission denied') ||
            checkError.code === '42501'
          )) {
            console.error('âŒ RLSç­–ç•¥é˜»æ­¢äº†æ“ä½œï¼Œè¯·æ£€æŸ¥RLSç­–ç•¥æˆ–ä½¿ç”¨Service Role Key')
            res.writeHead(500, { 'Content-Type': 'application/json' })
            res.end(JSON.stringify({
              success: false,
              message: 'æ“ä½œè´­ç‰©è½¦å¤±è´¥ï¼šæƒé™ä¸è¶³',
              error: 'RLSç­–ç•¥é˜»æ­¢äº†æ“ä½œ',
              details: 'è¯·æ£€æŸ¥RLSç­–ç•¥è®¾ç½®ï¼Œæˆ–é…ç½®SUPABASE_SERVICE_ROLE_KEYä»¥ç»•è¿‡RLS',
              hint: 'å¯ä»¥åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œ disable-cart-rls.sql æˆ– fix-cart-rls.sql æ¥ä¿®å¤'
            }))
            return
          }
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨ä¸å­˜åœ¨
          if (checkError.message && checkError.message.includes('relation "cart" does not exist')) {
            console.error('âŒ è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨')
            res.writeHead(500, { 'Content-Type': 'application/json' })
            res.end(JSON.stringify({
              success: false,
              message: 'è´­ç‰©è½¦åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨',
              error: 'è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨',
              details: 'è¯·å…ˆåœ¨Supabaseä¸­æ‰§è¡Œ create-cart-table.sql åˆ›å»ºè´­ç‰©è½¦è¡¨'
            }))
            return
          }
          
          // å…¶ä»–é”™è¯¯
          if (!checkError.message.includes('No rows') && !checkError.message.includes('PGRST116')) {
            console.error('âŒ æ£€æŸ¥è´­ç‰©è½¦é¡¹é”™è¯¯:', checkError)
            throw checkError
          }
        }
        
        let result
        if (existingItem) {
          // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°æ•°é‡
          const newQuantity = existingItem.cart_quantity + (cartData.quantity || 1)
          const { data, error } = await supabase
            .from('cart')
            .update({
              cart_quantity: newQuantity,
              cart_selected_size: cartData.selectedSize || existingItem.cart_selected_size,
              cart_selected_color: cartData.selectedColor || existingItem.cart_selected_color
            })
            .eq('cart_id', existingItem.cart_id)
            .select()
          
          if (error) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯RLSç­–ç•¥é”™è¯¯
            if (error.message && (
              error.message.includes('row-level security') ||
              error.message.includes('RLS') ||
              error.message.includes('permission denied') ||
              error.code === '42501'
            )) {
              console.error('âŒ RLSç­–ç•¥é˜»æ­¢äº†æ›´æ–°æ“ä½œï¼Œè¯·æ£€æŸ¥RLSç­–ç•¥æˆ–ä½¿ç”¨Service Role Key')
              res.writeHead(500, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: false,
                message: 'æ“ä½œè´­ç‰©è½¦å¤±è´¥ï¼šæƒé™ä¸è¶³',
                error: 'RLSç­–ç•¥é˜»æ­¢äº†æ“ä½œ',
                details: 'è¯·æ£€æŸ¥RLSç­–ç•¥è®¾ç½®ï¼Œæˆ–é…ç½®SUPABASE_SERVICE_ROLE_KEYä»¥ç»•è¿‡RLS',
                hint: 'å¯ä»¥åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œ disable-cart-rls.sql æˆ– fix-cart-rls.sql æ¥ä¿®å¤'
              }))
              return
            }
            throw error
          }
          result = { data, message: 'æ›´æ–°è´­ç‰©è½¦æˆåŠŸ' }
        } else {
          // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°é¡¹
          const { data, error } = await supabase
            .from('cart')
            .insert([{
              cart_user_id: userId,
              cart_product_id: cartData.productId,
              cart_quantity: cartData.quantity || 1,
              cart_selected_size: cartData.selectedSize || '',
              cart_selected_color: cartData.selectedColor || ''
            }])
            .select()
          
          if (error) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯RLSç­–ç•¥é”™è¯¯
            if (error.message && (
              error.message.includes('row-level security') ||
              error.message.includes('RLS') ||
              error.message.includes('permission denied') ||
              error.code === '42501'
            )) {
              console.error('âŒ RLSç­–ç•¥é˜»æ­¢äº†æ’å…¥æ“ä½œï¼Œè¯·æ£€æŸ¥RLSç­–ç•¥æˆ–ä½¿ç”¨Service Role Key')
              res.writeHead(500, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: false,
                message: 'æ“ä½œè´­ç‰©è½¦å¤±è´¥ï¼šæƒé™ä¸è¶³',
                error: 'RLSç­–ç•¥é˜»æ­¢äº†æ“ä½œ',
                details: 'è¯·æ£€æŸ¥RLSç­–ç•¥è®¾ç½®ï¼Œæˆ–é…ç½®SUPABASE_SERVICE_ROLE_KEYä»¥ç»•è¿‡RLS',
                hint: 'å¯ä»¥åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œ disable-cart-rls.sql æˆ– fix-cart-rls.sql æ¥ä¿®å¤'
              }))
              return
            }
            
            // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæç¤ºåˆ›å»ºè¡¨
            if (error.message && error.message.includes('relation "cart" does not exist')) {
              console.log('âš ï¸ è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨')
              res.writeHead(500, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: false,
                message: 'è´­ç‰©è½¦åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨',
                error: 'è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨',
                details: 'è¯·å…ˆåœ¨Supabaseä¸­æ‰§è¡Œ create-cart-table.sql åˆ›å»ºè´­ç‰©è½¦è¡¨'
              }))
              return
            }
            
            // æ£€æŸ¥å¤–é”®çº¦æŸé”™è¯¯
            if (error.message && (
              error.message.includes('foreign key') ||
              error.message.includes('violates foreign key constraint')
            )) {
              console.error('âŒ å¤–é”®çº¦æŸé”™è¯¯:', error.message)
              res.writeHead(400, { 'Content-Type': 'application/json' })
              res.end(JSON.stringify({
                success: false,
                message: 'æ“ä½œè´­ç‰©è½¦å¤±è´¥ï¼šå•†å“æˆ–ç”¨æˆ·ä¸å­˜åœ¨',
                error: error.message,
                details: 'è¯·ç¡®ä¿å•†å“IDå’Œç”¨æˆ·IDæœ‰æ•ˆ'
              }))
              return
            }
            
            throw error
          }
          result = { data, message: 'æ·»åŠ åˆ°è´­ç‰©è½¦æˆåŠŸ' }
        }
        
        console.log('âœ… æ“ä½œè´­ç‰©è½¦æˆåŠŸ')
        
        res.writeHead(201, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: result.message,
          data: result.data[0]
        }))
      } catch (error) {
        console.error('âŒ æ“ä½œè´­ç‰©è½¦é”™è¯¯:', error)
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          code: error.code,
          details: error.details,
          hint: error.hint
        })
        res.writeHead(500, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'æ“ä½œè´­ç‰©è½¦å¤±è´¥',
          error: error.message,
          details: error.details || error.hint || ''
        }))
      }
    })
    return
  }
  
  // æ›´æ–°è´­ç‰©è½¦æ¥å£
  if (req.url.startsWith('/api/cart/') && req.method === 'PUT') {
    let body = ''
    req.on('data', chunk => {
      body += chunk.toString()
    })
    
    req.on('end', async () => {
      try {
        const cartData = JSON.parse(body)
        
        // ä»URLæå–cartId
        const urlParts = req.url.split('/')
        const cartId = urlParts[urlParts.length - 1]
        
        if (!cartId || isNaN(cartId)) {
          res.writeHead(400, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è´­ç‰©è½¦IDæ— æ•ˆ'
          }))
          return
        }
        
        console.log('ğŸ›’ æ›´æ–°è´­ç‰©è½¦é¡¹:', cartId, cartData)
        
        const { data, error } = await supabase
          .from('cart')
          .update({
            cart_quantity: cartData.quantity
          })
          .eq('cart_id', cartId)
          .select()
        
        if (error) {
          if (error.message && error.message.includes('relation "cart" does not exist')) {
            console.log('âš ï¸ è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨')
            res.writeHead(500, { 'Content-Type': 'application/json' })
            res.end(JSON.stringify({
              success: false,
              message: 'è´­ç‰©è½¦åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
              error: 'è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨'
            }))
            return
          }
          throw error
        }
        
        console.log('âœ… æ›´æ–°è´­ç‰©è½¦æˆåŠŸ')
        
        res.writeHead(200, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: true,
          message: 'æ›´æ–°è´­ç‰©è½¦æˆåŠŸ',
          data: data[0]
        }))
      } catch (error) {
        console.error('âŒ æ›´æ–°è´­ç‰©è½¦é”™è¯¯:', error)
        res.writeHead(500, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'æ›´æ–°è´­ç‰©è½¦å¤±è´¥',
          error: error.message
        }))
      }
    })
    return
  }
  
  // åˆ é™¤è´­ç‰©è½¦æ¥å£
  if (req.url.startsWith('/api/cart/') && req.method === 'DELETE') {
    try {
      // ä»URLæå–cartId
      const urlParts = req.url.split('/')
      const cartId = urlParts[urlParts.length - 1]
      
      if (!cartId || isNaN(cartId)) {
        res.writeHead(400, { 'Content-Type': 'application/json' })
        res.end(JSON.stringify({
          success: false,
          message: 'è´­ç‰©è½¦IDæ— æ•ˆ'
        }))
        return
      }
      
      console.log('ğŸ›’ åˆ é™¤è´­ç‰©è½¦é¡¹:', cartId)
      
      const { error } = await supabase
        .from('cart')
        .delete()
        .eq('cart_id', cartId)
      
      if (error) {
        if (error.message && error.message.includes('relation "cart" does not exist')) {
          console.log('âš ï¸ è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨')
          res.writeHead(500, { 'Content-Type': 'application/json' })
          res.end(JSON.stringify({
            success: false,
            message: 'è´­ç‰©è½¦åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
            error: 'è´­ç‰©è½¦è¡¨ä¸å­˜åœ¨'
          }))
          return
        }
        throw error
      }
      
      console.log('âœ… åˆ é™¤è´­ç‰©è½¦é¡¹æˆåŠŸ')
      
      res.writeHead(200, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: true,
        message: 'åˆ é™¤è´­ç‰©è½¦é¡¹æˆåŠŸ'
      }))
    } catch (error) {
      console.error('âŒ åˆ é™¤è´­ç‰©è½¦é¡¹é”™è¯¯:', error)
      res.writeHead(500, { 'Content-Type': 'application/json' })
      res.end(JSON.stringify({
        success: false,
        message: 'åˆ é™¤è´­ç‰©è½¦é¡¹å¤±è´¥',
        error: error.message
      }))
    }
    return
  }
  
  // å…¶ä»–è¯·æ±‚
  res.writeHead(404, { 'Content-Type': 'application/json' })
  res.end(JSON.stringify({
    success: false,
    message: 'æ¥å£ä¸å­˜åœ¨'
  }))
})

const PORT = 3001
server.listen(PORT, () => {
  console.log('')
  console.log('ğŸ‰ Supabaseç‰ˆåç«¯æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!')
  console.log('ğŸ“ ç«¯å£:', PORT)
  console.log('ğŸŒ APIåœ°å€: http://localhost:' + PORT + '/api')
  console.log('ğŸ”§ æµ‹è¯•æ¥å£: http://localhost:' + PORT + '/api/test')
  console.log('ğŸ’¾ çœŸæ­£ä¿å­˜åˆ°Supabaseæ•°æ®åº“')
  console.log('')
  console.log('ç°åœ¨æ³¨å†Œä¼šçœŸæ­£ä¿å­˜åˆ°Supabaseï¼')
})